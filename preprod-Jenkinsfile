pipeline {
    agent any

    stages {
        stage('Run Script') {
            steps {
                script {
                    sh '''
                        cd /var/www/preprod
                        sudo git stash
                        sudo git pull origin preprod
                        sudo rm -rf /var/www/preprod/API/Build
                        sudo /opt/dotnet restore
                        sudo /opt/dotnet publish --framework net7.0 /var/www/preprod/API/mongodb-dotnet-example.csproj --configuration Release --output /var/www/preprod/API/Build
                        sudo pkill -f mongodb-dotnet-example
                        sudo rm -rf /var/www/preprod/API/Build/web.config
                        sudo rm -rf /var/www/preprod/API/Build/appsettings.Development.json
                        sudo rm -rf /var/www/preprod/API/Build/appsettings.Prod.json
                        sudo /opt/dotnet test /var/www/preprod/Tests/MongoTests/
                        sudo sshpass -p 'Welcome123' ssh testadmin@98.70.15.172 "C:\\Windows\\SysWOW64\\inetsrv\\appcmd.exe stop site /site.name:'preprod.com'"
                        echo "apppool stop"
                        sudo sshpass -p 'Welcome123' ssh testadmin@98.70.15.172 C:\\Windows\\SysWOW64\\inetsrv\\appcmd.exe stop apppool /apppool.name:"preprod.com"
                        echo "apppool stop"
                        sudo chmod 755 /var/www/preprod/API/Build -R
                        cd /var/www/preprod/API/Build
                        sudo lftp -e  "mirror --overwrite -R /var/www/preprod/API/Build .;quit" -u preprod,Welcome@123 98.70.15.172
                        sudo sshpass -p 'Welcome123' ssh testadmin@98.70.15.172 C:\\Windows\\SysWOW64\\inetsrv\\appcmd.exe start site /site.name:"preprod.com"
                        echo "apppool started"
                        sudo sshpass -p 'Welcome123' ssh testadmin@98.70.15.172 C:\\Windows\\SysWOW64\\inetsrv\\appcmd.exe start apppool /apppool.name:"preprod.com"
                        echo "site started"
                    '''
                }
            }
        }
    }
}
